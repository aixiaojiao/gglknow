<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twitter推文收藏器 - 调试工具</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .header {
            background: linear-gradient(135deg, #1da1f2 0%, #1991db 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .content {
            padding: 30px;
        }

        .debug-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e1e8ed;
            border-radius: 12px;
            background: #f8f9fa;
        }

        .debug-section h2 {
            color: #14171a;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .debug-item {
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #1da1f2;
        }

        .debug-item strong {
            color: #14171a;
            display: block;
            margin-bottom: 5px;
        }

        .debug-value {
            color: #657786;
            font-family: monospace;
            background: #f1f3f4;
            padding: 8px;
            border-radius: 4px;
            word-break: break-all;
        }

        .btn {
            background: #1da1f2;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            margin: 10px 5px;
            transition: all 0.2s ease;
        }

        .btn:hover {
            background: #1991db;
            transform: translateY(-1px);
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .status-good {
            color: #28a745;
            font-weight: bold;
        }

        .status-bad {
            color: #dc3545;
            font-weight: bold;
        }

        .status-warning {
            color: #ffc107;
            font-weight: bold;
        }

        .log-area {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .test-results {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔧 调试工具</h1>
            <p>诊断和解决Twitter推文收藏器的问题</p>
        </div>

        <div class="content">
            <div class="debug-section">
                <h2>📋 当前设置状态</h2>
                <div id="settingsStatus">
                    <div class="debug-item">
                        <strong>保存路径:</strong>
                        <div class="debug-value" id="currentPath">检查中...</div>
                    </div>
                    <div class="debug-item">
                        <strong>文件格式:</strong>
                        <div class="debug-value" id="currentFormat">检查中...</div>
                    </div>
                    <div class="debug-item">
                        <strong>下载媒体:</strong>
                        <div class="debug-value" id="currentMedia">检查中...</div>
                    </div>
                    <div class="debug-item">
                        <strong>设置状态:</strong>
                        <div class="debug-value" id="settingsValid">检查中...</div>
                    </div>
                </div>
                <button class="btn" id="checkSettingsBtn">🔄 重新检查设置</button>
                <button class="btn btn-danger" id="clearSettingsBtn">🗑️ 清除所有设置</button>
            </div>

            <div class="debug-section">
                <h2>🔐 权限检查</h2>
                <div id="permissionStatus">
                    <div class="debug-item">
                        <strong>下载权限:</strong>
                        <div class="debug-value" id="downloadPermission">检查中...</div>
                    </div>
                    <div class="debug-item">
                        <strong>存储权限:</strong>
                        <div class="debug-value" id="storagePermission">检查中...</div>
                    </div>
                    <div class="debug-item">
                        <strong>网站权限:</strong>
                        <div class="debug-value" id="hostPermission">检查中...</div>
                    </div>
                </div>
                <button class="btn" id="checkPermissionsBtn">🔄 重新检查权限</button>
            </div>

            <div class="debug-section">
                <h2>🧪 功能测试</h2>
                <button class="btn btn-success" id="testDownloadBtn">📥 测试下载功能</button>
                <button class="btn btn-success" id="testStorageBtn">💾 测试存储功能</button>
                <button class="btn btn-success" id="testPathValidationBtn">📁 测试路径验证</button>
                
                <div class="test-results" id="testResults"></div>
            </div>

            <div class="debug-section">
                <h2>📝 实时日志</h2>
                <div class="log-area" id="debugLog"></div>
                <button class="btn" id="clearLogBtn">🧹 清除日志</button>
                <button class="btn" id="exportLogBtn">📤 导出日志</button>
            </div>

            <div class="debug-section">
                <h2>🛠️ 修复工具</h2>
                <button class="btn btn-success" id="resetToDefaultBtn">🔧 重置为默认设置</button>
                <button class="btn btn-success" id="fixCommonIssuesBtn">🩹 修复常见问题</button>
            </div>
        </div>
    </div>

    <script>
        let debugLog = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            debugLog.push(logEntry);
            
            const logArea = document.getElementById('debugLog');
            logArea.textContent = debugLog.join('\n');
            logArea.scrollTop = logArea.scrollHeight;
            
            console.log(logEntry);
        }

        function clearLog() {
            debugLog = [];
            document.getElementById('debugLog').textContent = '';
            log('日志已清除');
        }

        function exportLog() {
            const logContent = debugLog.join('\n');
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `twitter-collector-debug-${new Date().toISOString().slice(0,10)}.log`;
            a.click();
            URL.revokeObjectURL(url);
            log('日志已导出');
        }

        async function checkSettings() {
            log('开始检查设置...');
            
            try {
                const settings = await new Promise((resolve) => {
                    chrome.storage.sync.get(['savePath', 'fileFormat', 'downloadMedia', 'lastUpdated'], resolve);
                });
                
                log('获取到设置: ' + JSON.stringify(settings));
                
                document.getElementById('currentPath').textContent = settings.savePath || '未设置';
                document.getElementById('currentFormat').textContent = settings.fileFormat || '未设置';
                document.getElementById('currentMedia').textContent = settings.downloadMedia !== undefined ? (settings.downloadMedia ? '是' : '否') : '未设置';
                
                let isValid = true;
                let issues = [];
                
                if (!settings.savePath) {
                    isValid = false;
                    issues.push('保存路径未设置');
                }
                
                if (!settings.fileFormat) {
                    issues.push('文件格式未设置');
                }
                
                const statusElement = document.getElementById('settingsValid');
                if (isValid && issues.length === 0) {
                    statusElement.innerHTML = '<span class="status-good">✅ 设置完整</span>';
                    log('设置检查通过');
                } else {
                    statusElement.innerHTML = '<span class="status-bad">❌ ' + issues.join(', ') + '</span>';
                    log('设置检查失败: ' + issues.join(', '));
                }
                
            } catch (error) {
                log('检查设置时出错: ' + error.message, 'error');
                document.getElementById('settingsValid').innerHTML = '<span class="status-bad">❌ 检查失败</span>';
            }
        }

        async function checkPermissions() {
            log('开始检查权限...');
            
            try {
                // 检查下载权限
                const hasDownloads = chrome.permissions && await chrome.permissions.contains({permissions: ['downloads']});
                document.getElementById('downloadPermission').innerHTML = hasDownloads ? 
                    '<span class="status-good">✅ 已授权</span>' : 
                    '<span class="status-bad">❌ 未授权</span>';
                log('下载权限: ' + (hasDownloads ? '已授权' : '未授权'));
                
                // 检查存储权限
                const hasStorage = chrome.permissions && await chrome.permissions.contains({permissions: ['storage']});
                document.getElementById('storagePermission').innerHTML = hasStorage ? 
                    '<span class="status-good">✅ 已授权</span>' : 
                    '<span class="status-bad">❌ 未授权</span>';
                log('存储权限: ' + (hasStorage ? '已授权' : '未授权'));
                
                // 检查网站权限
                const hasHost = chrome.permissions && await chrome.permissions.contains({
                    origins: ['https://twitter.com/*', 'https://x.com/*']
                });
                document.getElementById('hostPermission').innerHTML = hasHost ? 
                    '<span class="status-good">✅ 已授权</span>' : 
                    '<span class="status-bad">❌ 未授权</span>';
                log('网站权限: ' + (hasHost ? '已授权' : '未授权'));
                
            } catch (error) {
                log('检查权限时出错: ' + error.message, 'error');
            }
        }

        async function testDownload() {
            log('开始测试下载功能...');
            
            try {
                const testContent = JSON.stringify({
                    test: true,
                    timestamp: new Date().toISOString(),
                    message: '这是一个测试文件，可以安全删除'
                }, null, 2);

                const testFileName = `test_download_${Date.now()}.json`;

                chrome.downloads.download({
                    url: 'data:application/json;charset=utf-8,' + encodeURIComponent(testContent),
                    filename: testFileName,
                    saveAs: false
                }, (downloadId) => {
                    if (chrome.runtime.lastError) {
                        log('下载测试失败: ' + chrome.runtime.lastError.message, 'error');
                        showTestResult('下载功能', false, chrome.runtime.lastError.message);
                    } else {
                        log('下载测试成功，下载ID: ' + downloadId);
                        showTestResult('下载功能', true, '测试文件已下载到默认位置');
                        
                        // 清理测试文件
                        setTimeout(() => {
                            chrome.downloads.removeFile(downloadId, () => {
                                log('测试文件已清理');
                            });
                        }, 3000);
                    }
                });

            } catch (error) {
                log('下载测试出错: ' + error.message, 'error');
                showTestResult('下载功能', false, error.message);
            }
        }

        async function testStorage() {
            log('开始测试存储功能...');
            
            try {
                const testData = {
                    testKey: 'testValue_' + Date.now(),
                    timestamp: new Date().toISOString()
                };
                
                // 写入测试
                await new Promise((resolve, reject) => {
                    chrome.storage.sync.set(testData, () => {
                        if (chrome.runtime.lastError) {
                            reject(new Error(chrome.runtime.lastError.message));
                        } else {
                            resolve();
                        }
                    });
                });
                
                log('存储写入测试成功');
                
                // 读取测试
                const result = await new Promise((resolve) => {
                    chrome.storage.sync.get(['testKey'], resolve);
                });
                
                if (result.testKey === testData.testKey) {
                    log('存储读取测试成功');
                    showTestResult('存储功能', true, '读写操作正常');
                    
                    // 清理测试数据
                    chrome.storage.sync.remove(['testKey'], () => {
                        log('测试数据已清理');
                    });
                } else {
                    log('存储读取测试失败', 'error');
                    showTestResult('存储功能', false, '读取的数据不匹配');
                }
                
            } catch (error) {
                log('存储测试出错: ' + error.message, 'error');
                showTestResult('存储功能', false, error.message);
            }
        }

        async function testPathValidation() {
            log('开始测试路径验证...');
            
            const testPaths = [
                'TwitterCollections',
                'Downloads/Twitter',
                'Documents/TwitterBackup',
                'Desktop/推文收藏',
                'invalid<path>',
                '',
                'path/with/slashes/',
                'normal_path_123'
            ];
            
            let validPaths = 0;
            let invalidPaths = 0;
            
            testPaths.forEach(path => {
                const isValid = validatePath(path);
                if (isValid) {
                    validPaths++;
                    log(`路径验证通过: "${path}"`);
                } else {
                    invalidPaths++;
                    log(`路径验证失败: "${path}"`, 'warn');
                }
            });
            
            showTestResult('路径验证', true, `测试了${testPaths.length}个路径，${validPaths}个有效，${invalidPaths}个无效`);
        }

        function validatePath(path) {
            if (!path || !path.trim()) {
                return false;
            }
            
            const invalidChars = /[<>:"|?*]/;
            return !invalidChars.test(path);
        }

        function showTestResult(testName, success, message) {
            const resultsDiv = document.getElementById('testResults');
            const resultItem = document.createElement('div');
            resultItem.className = 'debug-item';
            resultItem.innerHTML = `
                <strong>${testName}:</strong>
                <div class="debug-value">
                    <span class="${success ? 'status-good' : 'status-bad'}">
                        ${success ? '✅' : '❌'} ${message}
                    </span>
                </div>
            `;
            resultsDiv.appendChild(resultItem);
        }

        async function clearSettings() {
            if (confirm('确定要清除所有设置吗？这将删除保存路径、文件格式等所有配置。')) {
                try {
                    await new Promise((resolve, reject) => {
                        chrome.storage.sync.clear(() => {
                            if (chrome.runtime.lastError) {
                                reject(new Error(chrome.runtime.lastError.message));
                            } else {
                                resolve();
                            }
                        });
                    });
                    
                    log('所有设置已清除');
                    alert('设置已清除，请重新配置插件');
                    checkSettings();
                } catch (error) {
                    log('清除设置失败: ' + error.message, 'error');
                    alert('清除设置失败: ' + error.message);
                }
            }
        }

        async function resetToDefault() {
            log('重置为默认设置...');
            
            try {
                const defaultSettings = {
                    savePath: 'TwitterCollections',
                    fileFormat: 'html',
                    downloadMedia: true,
                    lastUpdated: new Date().toISOString()
                };
                
                await new Promise((resolve, reject) => {
                    chrome.storage.sync.set(defaultSettings, () => {
                        if (chrome.runtime.lastError) {
                            reject(new Error(chrome.runtime.lastError.message));
                        } else {
                            resolve();
                        }
                    });
                });
                
                log('已重置为默认设置');
                alert('已重置为默认设置');
                checkSettings();
            } catch (error) {
                log('重置设置失败: ' + error.message, 'error');
                alert('重置设置失败: ' + error.message);
            }
        }

        async function fixCommonIssues() {
            log('开始修复常见问题...');
            
            try {
                // 检查并修复设置
                const settings = await new Promise((resolve) => {
                    chrome.storage.sync.get(['savePath', 'fileFormat', 'downloadMedia'], resolve);
                });
                
                let needsUpdate = false;
                const updates = {};
                
                if (!settings.savePath) {
                    updates.savePath = 'TwitterCollections';
                    needsUpdate = true;
                    log('修复: 设置默认保存路径');
                }
                
                if (!settings.fileFormat) {
                    updates.fileFormat = 'html';
                    needsUpdate = true;
                    log('修复: 设置默认文件格式');
                }
                
                if (settings.downloadMedia === undefined) {
                    updates.downloadMedia = true;
                    needsUpdate = true;
                    log('修复: 设置默认媒体下载选项');
                }
                
                if (needsUpdate) {
                    updates.lastUpdated = new Date().toISOString();
                    
                    await new Promise((resolve, reject) => {
                        chrome.storage.sync.set(updates, () => {
                            if (chrome.runtime.lastError) {
                                reject(new Error(chrome.runtime.lastError.message));
                            } else {
                                resolve();
                            }
                        });
                    });
                    
                    log('常见问题修复完成');
                    alert('常见问题已修复');
                } else {
                    log('未发现需要修复的问题');
                    alert('未发现需要修复的问题');
                }
                
                checkSettings();
            } catch (error) {
                log('修复过程中出错: ' + error.message, 'error');
                alert('修复失败: ' + error.message);
            }
        }

        // 页面加载时自动检查
        document.addEventListener('DOMContentLoaded', () => {
            log('调试工具已启动');
            
            // 绑定事件监听器
            document.getElementById('checkSettingsBtn').addEventListener('click', checkSettings);
            document.getElementById('clearSettingsBtn').addEventListener('click', clearSettings);
            document.getElementById('checkPermissionsBtn').addEventListener('click', checkPermissions);
            document.getElementById('testDownloadBtn').addEventListener('click', testDownload);
            document.getElementById('testStorageBtn').addEventListener('click', testStorage);
            document.getElementById('testPathValidationBtn').addEventListener('click', testPathValidation);
            document.getElementById('clearLogBtn').addEventListener('click', clearLog);
            document.getElementById('exportLogBtn').addEventListener('click', exportLog);
            document.getElementById('resetToDefaultBtn').addEventListener('click', resetToDefault);
            document.getElementById('fixCommonIssuesBtn').addEventListener('click', fixCommonIssues);
            
            checkSettings();
            checkPermissions();
        });
    </script>
</body>
</html> 