<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twitteræ¨æ–‡æ”¶è—å™¨ - è°ƒè¯•å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .header {
            background: linear-gradient(135deg, #1da1f2 0%, #1991db 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .content {
            padding: 30px;
        }

        .debug-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e1e8ed;
            border-radius: 12px;
            background: #f8f9fa;
        }

        .debug-section h2 {
            color: #14171a;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .debug-item {
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #1da1f2;
        }

        .debug-item strong {
            color: #14171a;
            display: block;
            margin-bottom: 5px;
        }

        .debug-value {
            color: #657786;
            font-family: monospace;
            background: #f1f3f4;
            padding: 8px;
            border-radius: 4px;
            word-break: break-all;
        }

        .btn {
            background: #1da1f2;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            margin: 10px 5px;
            transition: all 0.2s ease;
        }

        .btn:hover {
            background: #1991db;
            transform: translateY(-1px);
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .status-good {
            color: #28a745;
            font-weight: bold;
        }

        .status-bad {
            color: #dc3545;
            font-weight: bold;
        }

        .status-warning {
            color: #ffc107;
            font-weight: bold;
        }

        .log-area {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .test-results {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ è°ƒè¯•å·¥å…·</h1>
            <p>è¯Šæ–­å’Œè§£å†³Twitteræ¨æ–‡æ”¶è—å™¨çš„é—®é¢˜</p>
        </div>

        <div class="content">
            <div class="debug-section">
                <h2>ğŸ“‹ å½“å‰è®¾ç½®çŠ¶æ€</h2>
                <div id="settingsStatus">
                    <div class="debug-item">
                        <strong>ä¿å­˜è·¯å¾„:</strong>
                        <div class="debug-value" id="currentPath">æ£€æŸ¥ä¸­...</div>
                    </div>
                    <div class="debug-item">
                        <strong>æ–‡ä»¶æ ¼å¼:</strong>
                        <div class="debug-value" id="currentFormat">æ£€æŸ¥ä¸­...</div>
                    </div>
                    <div class="debug-item">
                        <strong>ä¸‹è½½åª’ä½“:</strong>
                        <div class="debug-value" id="currentMedia">æ£€æŸ¥ä¸­...</div>
                    </div>
                    <div class="debug-item">
                        <strong>è®¾ç½®çŠ¶æ€:</strong>
                        <div class="debug-value" id="settingsValid">æ£€æŸ¥ä¸­...</div>
                    </div>
                </div>
                <button class="btn" id="checkSettingsBtn">ğŸ”„ é‡æ–°æ£€æŸ¥è®¾ç½®</button>
                <button class="btn btn-danger" id="clearSettingsBtn">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰è®¾ç½®</button>
            </div>

            <div class="debug-section">
                <h2>ğŸ” æƒé™æ£€æŸ¥</h2>
                <div id="permissionStatus">
                    <div class="debug-item">
                        <strong>ä¸‹è½½æƒé™:</strong>
                        <div class="debug-value" id="downloadPermission">æ£€æŸ¥ä¸­...</div>
                    </div>
                    <div class="debug-item">
                        <strong>å­˜å‚¨æƒé™:</strong>
                        <div class="debug-value" id="storagePermission">æ£€æŸ¥ä¸­...</div>
                    </div>
                    <div class="debug-item">
                        <strong>ç½‘ç«™æƒé™:</strong>
                        <div class="debug-value" id="hostPermission">æ£€æŸ¥ä¸­...</div>
                    </div>
                </div>
                <button class="btn" id="checkPermissionsBtn">ğŸ”„ é‡æ–°æ£€æŸ¥æƒé™</button>
            </div>

            <div class="debug-section">
                <h2>ğŸ§ª åŠŸèƒ½æµ‹è¯•</h2>
                <button class="btn btn-success" id="testDownloadBtn">ğŸ“¥ æµ‹è¯•ä¸‹è½½åŠŸèƒ½</button>
                <button class="btn btn-success" id="testStorageBtn">ğŸ’¾ æµ‹è¯•å­˜å‚¨åŠŸèƒ½</button>
                <button class="btn btn-success" id="testPathValidationBtn">ğŸ“ æµ‹è¯•è·¯å¾„éªŒè¯</button>
                
                <div class="test-results" id="testResults"></div>
            </div>

            <div class="debug-section">
                <h2>ğŸ“ å®æ—¶æ—¥å¿—</h2>
                <div class="log-area" id="debugLog"></div>
                <button class="btn" id="clearLogBtn">ğŸ§¹ æ¸…é™¤æ—¥å¿—</button>
                <button class="btn" id="exportLogBtn">ğŸ“¤ å¯¼å‡ºæ—¥å¿—</button>
            </div>

            <div class="debug-section">
                <h2>ğŸ› ï¸ ä¿®å¤å·¥å…·</h2>
                <button class="btn btn-success" id="resetToDefaultBtn">ğŸ”§ é‡ç½®ä¸ºé»˜è®¤è®¾ç½®</button>
                <button class="btn btn-success" id="fixCommonIssuesBtn">ğŸ©¹ ä¿®å¤å¸¸è§é—®é¢˜</button>
            </div>
        </div>
    </div>

    <script>
        let debugLog = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            debugLog.push(logEntry);
            
            const logArea = document.getElementById('debugLog');
            logArea.textContent = debugLog.join('\n');
            logArea.scrollTop = logArea.scrollHeight;
            
            console.log(logEntry);
        }

        function clearLog() {
            debugLog = [];
            document.getElementById('debugLog').textContent = '';
            log('æ—¥å¿—å·²æ¸…é™¤');
        }

        function exportLog() {
            const logContent = debugLog.join('\n');
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `twitter-collector-debug-${new Date().toISOString().slice(0,10)}.log`;
            a.click();
            URL.revokeObjectURL(url);
            log('æ—¥å¿—å·²å¯¼å‡º');
        }

        async function checkSettings() {
            log('å¼€å§‹æ£€æŸ¥è®¾ç½®...');
            
            try {
                const settings = await new Promise((resolve) => {
                    chrome.storage.sync.get(['savePath', 'fileFormat', 'downloadMedia', 'lastUpdated'], resolve);
                });
                
                log('è·å–åˆ°è®¾ç½®: ' + JSON.stringify(settings));
                
                document.getElementById('currentPath').textContent = settings.savePath || 'æœªè®¾ç½®';
                document.getElementById('currentFormat').textContent = settings.fileFormat || 'æœªè®¾ç½®';
                document.getElementById('currentMedia').textContent = settings.downloadMedia !== undefined ? (settings.downloadMedia ? 'æ˜¯' : 'å¦') : 'æœªè®¾ç½®';
                
                let isValid = true;
                let issues = [];
                
                if (!settings.savePath) {
                    isValid = false;
                    issues.push('ä¿å­˜è·¯å¾„æœªè®¾ç½®');
                }
                
                if (!settings.fileFormat) {
                    issues.push('æ–‡ä»¶æ ¼å¼æœªè®¾ç½®');
                }
                
                const statusElement = document.getElementById('settingsValid');
                if (isValid && issues.length === 0) {
                    statusElement.innerHTML = '<span class="status-good">âœ… è®¾ç½®å®Œæ•´</span>';
                    log('è®¾ç½®æ£€æŸ¥é€šè¿‡');
                } else {
                    statusElement.innerHTML = '<span class="status-bad">âŒ ' + issues.join(', ') + '</span>';
                    log('è®¾ç½®æ£€æŸ¥å¤±è´¥: ' + issues.join(', '));
                }
                
            } catch (error) {
                log('æ£€æŸ¥è®¾ç½®æ—¶å‡ºé”™: ' + error.message, 'error');
                document.getElementById('settingsValid').innerHTML = '<span class="status-bad">âŒ æ£€æŸ¥å¤±è´¥</span>';
            }
        }

        async function checkPermissions() {
            log('å¼€å§‹æ£€æŸ¥æƒé™...');
            
            try {
                // æ£€æŸ¥ä¸‹è½½æƒé™
                const hasDownloads = chrome.permissions && await chrome.permissions.contains({permissions: ['downloads']});
                document.getElementById('downloadPermission').innerHTML = hasDownloads ? 
                    '<span class="status-good">âœ… å·²æˆæƒ</span>' : 
                    '<span class="status-bad">âŒ æœªæˆæƒ</span>';
                log('ä¸‹è½½æƒé™: ' + (hasDownloads ? 'å·²æˆæƒ' : 'æœªæˆæƒ'));
                
                // æ£€æŸ¥å­˜å‚¨æƒé™
                const hasStorage = chrome.permissions && await chrome.permissions.contains({permissions: ['storage']});
                document.getElementById('storagePermission').innerHTML = hasStorage ? 
                    '<span class="status-good">âœ… å·²æˆæƒ</span>' : 
                    '<span class="status-bad">âŒ æœªæˆæƒ</span>';
                log('å­˜å‚¨æƒé™: ' + (hasStorage ? 'å·²æˆæƒ' : 'æœªæˆæƒ'));
                
                // æ£€æŸ¥ç½‘ç«™æƒé™
                const hasHost = chrome.permissions && await chrome.permissions.contains({
                    origins: ['https://twitter.com/*', 'https://x.com/*']
                });
                document.getElementById('hostPermission').innerHTML = hasHost ? 
                    '<span class="status-good">âœ… å·²æˆæƒ</span>' : 
                    '<span class="status-bad">âŒ æœªæˆæƒ</span>';
                log('ç½‘ç«™æƒé™: ' + (hasHost ? 'å·²æˆæƒ' : 'æœªæˆæƒ'));
                
            } catch (error) {
                log('æ£€æŸ¥æƒé™æ—¶å‡ºé”™: ' + error.message, 'error');
            }
        }

        async function testDownload() {
            log('å¼€å§‹æµ‹è¯•ä¸‹è½½åŠŸèƒ½...');
            
            try {
                const testContent = JSON.stringify({
                    test: true,
                    timestamp: new Date().toISOString(),
                    message: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ–‡ä»¶ï¼Œå¯ä»¥å®‰å…¨åˆ é™¤'
                }, null, 2);

                const testFileName = `test_download_${Date.now()}.json`;

                chrome.downloads.download({
                    url: 'data:application/json;charset=utf-8,' + encodeURIComponent(testContent),
                    filename: testFileName,
                    saveAs: false
                }, (downloadId) => {
                    if (chrome.runtime.lastError) {
                        log('ä¸‹è½½æµ‹è¯•å¤±è´¥: ' + chrome.runtime.lastError.message, 'error');
                        showTestResult('ä¸‹è½½åŠŸèƒ½', false, chrome.runtime.lastError.message);
                    } else {
                        log('ä¸‹è½½æµ‹è¯•æˆåŠŸï¼Œä¸‹è½½ID: ' + downloadId);
                        showTestResult('ä¸‹è½½åŠŸèƒ½', true, 'æµ‹è¯•æ–‡ä»¶å·²ä¸‹è½½åˆ°é»˜è®¤ä½ç½®');
                        
                        // æ¸…ç†æµ‹è¯•æ–‡ä»¶
                        setTimeout(() => {
                            chrome.downloads.removeFile(downloadId, () => {
                                log('æµ‹è¯•æ–‡ä»¶å·²æ¸…ç†');
                            });
                        }, 3000);
                    }
                });

            } catch (error) {
                log('ä¸‹è½½æµ‹è¯•å‡ºé”™: ' + error.message, 'error');
                showTestResult('ä¸‹è½½åŠŸèƒ½', false, error.message);
            }
        }

        async function testStorage() {
            log('å¼€å§‹æµ‹è¯•å­˜å‚¨åŠŸèƒ½...');
            
            try {
                const testData = {
                    testKey: 'testValue_' + Date.now(),
                    timestamp: new Date().toISOString()
                };
                
                // å†™å…¥æµ‹è¯•
                await new Promise((resolve, reject) => {
                    chrome.storage.sync.set(testData, () => {
                        if (chrome.runtime.lastError) {
                            reject(new Error(chrome.runtime.lastError.message));
                        } else {
                            resolve();
                        }
                    });
                });
                
                log('å­˜å‚¨å†™å…¥æµ‹è¯•æˆåŠŸ');
                
                // è¯»å–æµ‹è¯•
                const result = await new Promise((resolve) => {
                    chrome.storage.sync.get(['testKey'], resolve);
                });
                
                if (result.testKey === testData.testKey) {
                    log('å­˜å‚¨è¯»å–æµ‹è¯•æˆåŠŸ');
                    showTestResult('å­˜å‚¨åŠŸèƒ½', true, 'è¯»å†™æ“ä½œæ­£å¸¸');
                    
                    // æ¸…ç†æµ‹è¯•æ•°æ®
                    chrome.storage.sync.remove(['testKey'], () => {
                        log('æµ‹è¯•æ•°æ®å·²æ¸…ç†');
                    });
                } else {
                    log('å­˜å‚¨è¯»å–æµ‹è¯•å¤±è´¥', 'error');
                    showTestResult('å­˜å‚¨åŠŸèƒ½', false, 'è¯»å–çš„æ•°æ®ä¸åŒ¹é…');
                }
                
            } catch (error) {
                log('å­˜å‚¨æµ‹è¯•å‡ºé”™: ' + error.message, 'error');
                showTestResult('å­˜å‚¨åŠŸèƒ½', false, error.message);
            }
        }

        async function testPathValidation() {
            log('å¼€å§‹æµ‹è¯•è·¯å¾„éªŒè¯...');
            
            const testPaths = [
                'TwitterCollections',
                'Downloads/Twitter',
                'Documents/TwitterBackup',
                'Desktop/æ¨æ–‡æ”¶è—',
                'invalid<path>',
                '',
                'path/with/slashes/',
                'normal_path_123'
            ];
            
            let validPaths = 0;
            let invalidPaths = 0;
            
            testPaths.forEach(path => {
                const isValid = validatePath(path);
                if (isValid) {
                    validPaths++;
                    log(`è·¯å¾„éªŒè¯é€šè¿‡: "${path}"`);
                } else {
                    invalidPaths++;
                    log(`è·¯å¾„éªŒè¯å¤±è´¥: "${path}"`, 'warn');
                }
            });
            
            showTestResult('è·¯å¾„éªŒè¯', true, `æµ‹è¯•äº†${testPaths.length}ä¸ªè·¯å¾„ï¼Œ${validPaths}ä¸ªæœ‰æ•ˆï¼Œ${invalidPaths}ä¸ªæ— æ•ˆ`);
        }

        function validatePath(path) {
            if (!path || !path.trim()) {
                return false;
            }
            
            const invalidChars = /[<>:"|?*]/;
            return !invalidChars.test(path);
        }

        function showTestResult(testName, success, message) {
            const resultsDiv = document.getElementById('testResults');
            const resultItem = document.createElement('div');
            resultItem.className = 'debug-item';
            resultItem.innerHTML = `
                <strong>${testName}:</strong>
                <div class="debug-value">
                    <span class="${success ? 'status-good' : 'status-bad'}">
                        ${success ? 'âœ…' : 'âŒ'} ${message}
                    </span>
                </div>
            `;
            resultsDiv.appendChild(resultItem);
        }

        async function clearSettings() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰è®¾ç½®å—ï¼Ÿè¿™å°†åˆ é™¤ä¿å­˜è·¯å¾„ã€æ–‡ä»¶æ ¼å¼ç­‰æ‰€æœ‰é…ç½®ã€‚')) {
                try {
                    await new Promise((resolve, reject) => {
                        chrome.storage.sync.clear(() => {
                            if (chrome.runtime.lastError) {
                                reject(new Error(chrome.runtime.lastError.message));
                            } else {
                                resolve();
                            }
                        });
                    });
                    
                    log('æ‰€æœ‰è®¾ç½®å·²æ¸…é™¤');
                    alert('è®¾ç½®å·²æ¸…é™¤ï¼Œè¯·é‡æ–°é…ç½®æ’ä»¶');
                    checkSettings();
                } catch (error) {
                    log('æ¸…é™¤è®¾ç½®å¤±è´¥: ' + error.message, 'error');
                    alert('æ¸…é™¤è®¾ç½®å¤±è´¥: ' + error.message);
                }
            }
        }

        async function resetToDefault() {
            log('é‡ç½®ä¸ºé»˜è®¤è®¾ç½®...');
            
            try {
                const defaultSettings = {
                    savePath: 'TwitterCollections',
                    fileFormat: 'html',
                    downloadMedia: true,
                    lastUpdated: new Date().toISOString()
                };
                
                await new Promise((resolve, reject) => {
                    chrome.storage.sync.set(defaultSettings, () => {
                        if (chrome.runtime.lastError) {
                            reject(new Error(chrome.runtime.lastError.message));
                        } else {
                            resolve();
                        }
                    });
                });
                
                log('å·²é‡ç½®ä¸ºé»˜è®¤è®¾ç½®');
                alert('å·²é‡ç½®ä¸ºé»˜è®¤è®¾ç½®');
                checkSettings();
            } catch (error) {
                log('é‡ç½®è®¾ç½®å¤±è´¥: ' + error.message, 'error');
                alert('é‡ç½®è®¾ç½®å¤±è´¥: ' + error.message);
            }
        }

        async function fixCommonIssues() {
            log('å¼€å§‹ä¿®å¤å¸¸è§é—®é¢˜...');
            
            try {
                // æ£€æŸ¥å¹¶ä¿®å¤è®¾ç½®
                const settings = await new Promise((resolve) => {
                    chrome.storage.sync.get(['savePath', 'fileFormat', 'downloadMedia'], resolve);
                });
                
                let needsUpdate = false;
                const updates = {};
                
                if (!settings.savePath) {
                    updates.savePath = 'TwitterCollections';
                    needsUpdate = true;
                    log('ä¿®å¤: è®¾ç½®é»˜è®¤ä¿å­˜è·¯å¾„');
                }
                
                if (!settings.fileFormat) {
                    updates.fileFormat = 'html';
                    needsUpdate = true;
                    log('ä¿®å¤: è®¾ç½®é»˜è®¤æ–‡ä»¶æ ¼å¼');
                }
                
                if (settings.downloadMedia === undefined) {
                    updates.downloadMedia = true;
                    needsUpdate = true;
                    log('ä¿®å¤: è®¾ç½®é»˜è®¤åª’ä½“ä¸‹è½½é€‰é¡¹');
                }
                
                if (needsUpdate) {
                    updates.lastUpdated = new Date().toISOString();
                    
                    await new Promise((resolve, reject) => {
                        chrome.storage.sync.set(updates, () => {
                            if (chrome.runtime.lastError) {
                                reject(new Error(chrome.runtime.lastError.message));
                            } else {
                                resolve();
                            }
                        });
                    });
                    
                    log('å¸¸è§é—®é¢˜ä¿®å¤å®Œæˆ');
                    alert('å¸¸è§é—®é¢˜å·²ä¿®å¤');
                } else {
                    log('æœªå‘ç°éœ€è¦ä¿®å¤çš„é—®é¢˜');
                    alert('æœªå‘ç°éœ€è¦ä¿®å¤çš„é—®é¢˜');
                }
                
                checkSettings();
            } catch (error) {
                log('ä¿®å¤è¿‡ç¨‹ä¸­å‡ºé”™: ' + error.message, 'error');
                alert('ä¿®å¤å¤±è´¥: ' + error.message);
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        document.addEventListener('DOMContentLoaded', () => {
            log('è°ƒè¯•å·¥å…·å·²å¯åŠ¨');
            
            // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
            document.getElementById('checkSettingsBtn').addEventListener('click', checkSettings);
            document.getElementById('clearSettingsBtn').addEventListener('click', clearSettings);
            document.getElementById('checkPermissionsBtn').addEventListener('click', checkPermissions);
            document.getElementById('testDownloadBtn').addEventListener('click', testDownload);
            document.getElementById('testStorageBtn').addEventListener('click', testStorage);
            document.getElementById('testPathValidationBtn').addEventListener('click', testPathValidation);
            document.getElementById('clearLogBtn').addEventListener('click', clearLog);
            document.getElementById('exportLogBtn').addEventListener('click', exportLog);
            document.getElementById('resetToDefaultBtn').addEventListener('click', resetToDefault);
            document.getElementById('fixCommonIssuesBtn').addEventListener('click', fixCommonIssues);
            
            checkSettings();
            checkPermissions();
        });
    </script>
</body>
</html> 